---
const {btnType} = Astro.props
const buttonT = btnType === 'footer' ? "btn-success" : "btn-ghost"
const dropdownT = btnType === 'footer' ? "dropdown-bottom" : "dropdown-center"
const { pathname } = Astro.url;
const isItalian = pathname.startsWith("/it");

// paths without it localization should be put here 
const untranslatedPaths = ["/blog", "/posts"];
const disableItalian = untranslatedPaths.some((path) => pathname.includes(path));

const currentLang = isItalian ? "it" : "en";
---

<div class=`dropdown ${dropdownT}`>
  
  <div tabindex="0" role="button" class=`btn ${buttonT} btn-sm text-md`  aria-label="Language Selector">
    {isItalian ? "[it]" : "[en]"}
  </div>

  <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
    
    <li>
      <button 
        class="lang-btn flex justify-between" 
        data-lang="en"
        disabled={!isItalian} 
      >
        <span>ðŸ‡¬ðŸ‡§ English</span>
        {!isItalian && <span class="text-xs font-bold">âœ“</span>}
      </button>
    </li>

    <li>
      <button 
        class="lang-btn flex justify-between" 
        data-lang="it" 
        disabled={isItalian || disableItalian} 
        title={disableItalian ? "Translation not available" : ""}
      >
        <span class={disableItalian ? "opacity-50" : ""}>ðŸ‡®ðŸ‡¹ Italiano</span>
        
        {isItalian && <span class="text-xs font-bold">âœ“</span>}
        {disableItalian && <span class="badge badge-xs badge-ghost">N/A</span>}
      </button>
    </li>

  </ul>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const currentPath = window.location.pathname;
    const isItalianPath = currentPath.startsWith("/it");

    const savedLang = localStorage.getItem("lang");
    
    const itBtn = document.querySelector('button[data-lang="it"]') as HTMLButtonElement | null;
    const isItDisabled = itBtn?.disabled || false;

    if (savedLang === "it" && !isItalianPath && !isItDisabled) {
      window.location.replace("/it" + currentPath);
    } 

    else if (savedLang === "en" && isItalianPath) {
      window.location.replace(currentPath.replace(/^\/it/, "") || "/");
    }

    const buttons = document.querySelectorAll('.lang-btn');
    
    buttons.forEach((btn) => {
      btn.addEventListener("click", (e) => {

        const target = e.currentTarget as HTMLButtonElement;
        const selectedLang = target.dataset.lang; // "en" o "it"

        if (!selectedLang) return;

        localStorage.setItem("lang", selectedLang);

        if (selectedLang === "it") {
       
           window.location.assign("/it" + currentPath);
        } else {
           const newPath = currentPath.replace(/^\/it/, "") || "/";
           window.location.assign(newPath);
        }
      });
    });
  });
</script>